<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Family Groceries</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root {
            --bg-color: #F0F4F8; --card-bg: #FFFFFF; --primary: #6366F1;
            --text-dark: #1F2937; --text-light: #6B7280; --danger: #EF4444;
            --success: #10B981; --radius: 16px; --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
        }
        body { background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; color: var(--text-dark); -webkit-tap-highlight-color: transparent; }
        .app-container { max-width: 600px; margin: 0 auto; padding-bottom: 80px; }
        
        /* HEADER & LOGIN */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.5rem; margin: 0; font-weight: 700; }
        #user-info { font-size: 0.8rem; color: var(--text-light); }
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 1000; display: flex; flex-direction: column; justify-content: center; align-items: center; }

        /* INPUT CARD */
        .input-card { background: var(--card-bg); padding: 16px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 20px; transition: all 0.2s; }
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select { border: 1px solid #E5E7EB; border-radius: 12px; padding: 12px; font-size: 1rem; outline: none; background: #F9FAFB; width: 100%; box-sizing: border-box; }
        input:focus, select:focus { border-color: var(--primary); background: white; }
        
        /* AUTOCOMPLETE GHOST */
        .autocomplete-wrapper { position: relative; width: 100%; flex-grow: 1; }
        .ghost-input { position: absolute; top: 0; left: 0; color: #9CA3AF; pointer-events: none; z-index: 1; background: transparent; border-color: transparent; }
        .real-input { position: relative; z-index: 2; background: transparent; }
        .real-input:focus { background: white; }

        /* BUTTONS */
        button { border: none; border-radius: 12px; padding: 10px 16px; font-weight: 600; cursor: pointer; font-size: 0.9rem; }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-action { background: #F3F4F6; color: var(--text-dark); padding: 8px 12px; }
        .btn-delete { color: var(--danger); background: #FEF2F2; }
        .btn-gotit { background: var(--success); color: white; }
        .btn-undo { background: #E5E7EB; color: var(--text-dark); }

        /* LIST */
        .category-header { font-size: 0.75rem; font-weight: 700; color: var(--text-light); text-transform: uppercase; margin: 24px 0 8px 4px; letter-spacing: 1px; }
        .item-card { background: var(--card-bg); padding: 16px; border-radius: var(--radius); box-shadow: var(--shadow); margin-bottom: 12px; animation: slideIn 0.2s ease-out; }
        .item-card.completed { opacity: 0.6; background: #F9FAFB; }
        .item-card.completed .item-name { text-decoration: line-through; color: var(--text-light); }
        .item-top { display: flex; justify-content: space-between; align-items: center; }
        .item-details { font-size: 0.85rem; color: var(--text-light); margin-top: 4px; }
        .item-actions { display: flex; gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #F3F4F6; }

        /* EDIT MODE */
        .edit-mode-inputs { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }

        @keyframes slideIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="login-overlay" class="login-overlay">
    <h2 style="margin-bottom: 2rem;">Family Shopping List</h2>
    <div id="g_id_onload"
         data-client_id="392731380750-eueqqluhmq4ir3e6gs5v2jv5m7afj87u.apps.googleusercontent.com"
         data-callback="handleCredentialResponse"
         data-auto_prompt="false"></div>
    <div class="g_id_signin" data-type="standard" data-size="large"></div>
</div>

<div class="app-container">
    <div class="header">
        <h1>Groceries</h1>
        <div id="user-info">
            <span id="user-email"></span>
            <button onclick="logout()" style="background:none; color:var(--danger); font-size:0.8rem; padding:0; margin-left:8px;">Logout</button>
        </div>
    </div>

    <div class="input-card">
        <div class="input-row">
            <div class="autocomplete-wrapper">
                <input type="text" class="ghost-input" id="ghostInput" disabled>
                <input type="text" id="add-item" class="real-input" placeholder="What do we need?">
            </div>
        </div>
        <div class="input-row">
            <select id="add-store" style="width: 60%;">
                <option value="">Any Store</option>
                <option>Red Barn</option><option>Fairways</option><option>Thriftys</option>
                <option>SaveOn</option><option>Costco</option>
            </select>
            <input type="number" id="add-price" placeholder="$ Price" step="0.01">
        </div>
        <div class="input-row">
            <input type="text" id="add-note" placeholder="Notes (e.g. '3 bags')">
        </div>
        <button class="btn-primary" onclick="addItem()">Add to List</button>
    </div>

    <select id="filter-store" onchange="renderList()" style="margin-bottom: 20px; box-shadow: var(--shadow); border:none;">
        <option value="">Show All Stores</option>
        <option>Red Barn</option><option>Fairways</option><option>Thriftys</option>
        <option>SaveOn</option><option>Costco</option>
    </select>

    <div id="shoppingList">Loading...</div>

    <button id="clear-btn" class="btn-action" style="width:100%; margin-top:30px; color:var(--text-light);" onclick="clearCompleted()">Clear Completed Items</button>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const API_URL = "https://egs3mnycu7jr724qappinabedi0qbsvh.lambda-url.us-east-1.on.aws/";
    let userToken = localStorage.getItem('google_token');
    let userEmail = localStorage.getItem('user_email');
    
    // --- 2. DATA (Ported from PHP) ---
    const groceryMapping = {
        "Milk": "Dairy", "Eggs": "Dairy", "Butter": "Dairy", "Cheese": "Dairy", "Yogurt": "Dairy", "Cream": "Dairy",
        "Apples": "Produce", "Bananas": "Produce", "Avocados": "Produce", "Onions": "Produce", "Potatoes": "Produce", "Carrots": "Produce",
        "Lettuce": "Produce", "Spinach": "Produce", "Tomatoes": "Produce", "Peppers": "Produce", "Garlic": "Produce",
        "Chicken": "Meat", "Beef": "Meat", "Bacon": "Meat", "Sausage": "Meat", "Fish": "Seafood", "Salmon": "Seafood",
        "Bread": "Bakery", "Bagels": "Bakery", "Tortillas": "Bakery", "Buns": "Bakery",
        "Pasta": "Pantry", "Rice": "Pantry", "Sauce": "Pantry", "Cereal": "Pantry", "Oatmeal": "Pantry", "Coffee": "Beverages",
        "Chips": "Snacks", "Crackers": "Snacks", "Nuts": "Snacks", "Chocolate": "Snacks",
        "Toilet Paper": "Household", "Paper Towels": "Household", "Soap": "Household", "Detergent": "Household"
    };
    const groceryItems = Object.keys(groceryMapping);
    let allItems = []; // Local cache of items

    // --- 3. AUTHENTICATION ---
    if (userToken) {
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('user-email').textContent = userEmail.split('@')[0];
        fetchItems();
    }

    function handleCredentialResponse(response) {
        // Decode JWT to get email (for display only, real verification happens on server if you enable it)
        const payload = JSON.parse(atob(response.credential.split('.')[1]));
        userToken = response.credential;
        userEmail = payload.email;
        
        localStorage.setItem('google_token', userToken);
        localStorage.setItem('user_email', userEmail);
        
        document.getElementById('login-overlay').style.display = 'none';
        document.getElementById('user-email').textContent = userEmail.split('@')[0];
        fetchItems();
    }

    function logout() {
        localStorage.clear();
        location.reload();
    }

    // --- 4. CORE API FUNCTIONS ---
    async function api(method, body = {}) {
        try {
            const res = await fetch(API_URL, {
                method: method,
                headers: { 
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + userToken 
                },
                body: method === 'GET' ? null : JSON.stringify(body)
            });
            if (!res.ok) throw new Error("API Error");
            return await res.json();
        } catch (e) {
            console.error(e);
            alert("Connection error. Check console.");
        }
    }

	async function fetchItems() {
			// 1. SAFETY CHECK: Don't refresh if user is typing
			const isUserBusy = allItems.some(item => item.isEditing);
			if (isUserBusy) return;

			// 2. GET DATA
			let data = await api('GET');
			data = data || [];

			// 3. THE FIX: SORT BOTH LISTS BEFORE COMPARING
			// We create temporary "comparison strings" by sorting by name
			const sortFunc = (a, b) => a.item_name.localeCompare(b.item_name);
			
			const newJson = JSON.stringify([...data].sort(sortFunc));
			const oldJson = JSON.stringify([...allItems].sort(sortFunc));

			// 4. ONLY RENDER IF CONTENT ACTUALLY CHANGED
			if (newJson !== oldJson) {
				console.log("Syncing changes...");
				allItems = data; // Update the source of truth
				renderList();    // Redraw
			}
		}

		// --- 8. AUTO-UPDATE LOOP ---
		// Check for updates every 10 seconds (More frequent is fine for DynamoDB)
		setInterval(fetchItems, 10000); 

		// Initial Load
		fetchItems();

    // --- 5. RENDER LOGIC ---
    function renderList() {
        const listDiv = document.getElementById('shoppingList');
        const storeFilter = document.getElementById('filter-store').value;
        listDiv.innerHTML = '';

        // Sort: Category -> Status -> ID
        const sorted = allItems.sort((a, b) => {
            if (a.status !== b.status) return a.status - b.status; // Pending first
            const catA = a.category || 'Other';
            const catB = b.category || 'Other';
            return catA.localeCompare(catB);
        });

        let currentCat = '';
        let hasCompleted = false;

        sorted.forEach(item => {
            if (storeFilter && item.store !== storeFilter) return;
            if (item.status === 1) hasCompleted = true;

            // Header
            const cat = item.category || 'Other';
            if (cat !== currentCat && item.status === 0) {
                currentCat = cat;
                listDiv.innerHTML += `<div class="category-header">${cat}</div>`;
            }

            // Card HTML
            const isDone = item.status === 1;
            const priceDisplay = parseFloat(item.price) > 0 ? `$${parseFloat(item.price).toFixed(2)}` : '';
            const details = [item.store, priceDisplay, item.note].filter(Boolean).join(' â€¢ ');

            const div = document.createElement('div');
            div.className = `item-card ${isDone ? 'completed' : ''}`;
            
            // VIEW MODE
            if (!item.isEditing) {
                div.innerHTML = `
                    <div class="item-top">
                        <div>
                            <div class="item-name" style="font-weight:600; font-size:1.05rem;">${item.item_name}</div>
                            <div class="item-details">${details}</div>
                        </div>
                        ${!isDone 
                            ? `<button class="btn-gotit" onclick="updateStatus('${item.item_name}', 'gotit')">Got It</button>`
                            : `<button class="btn-undo" onclick="updateStatus('${item.item_name}', 'undo')">Undo</button>`
                        }
                    </div>
                    ${!isDone ? `
                    <div class="item-actions">
                        <button class="btn-action" onclick="enableEdit('${item.item_name}')">Edit</button>
                        <button class="btn-delete" style="background:none;" onclick="deleteItem('${item.item_name}')">Delete</button>
                    </div>` : ''}
                `;
            } 
            // EDIT MODE
            else {
                div.innerHTML = `
                    <div class="edit-mode-inputs">
                        <label style="font-size:0.8rem; font-weight:bold; color:var(--primary);">Editing ${item.item_name}</label>
                        <select id="edit-store-${item.item_name}">
                            <option value="">Store</option>
                            <option ${item.store=='Red Barn'?'selected':''}>Red Barn</option>
                            <option ${item.store=='Costco'?'selected':''}>Costco</option>
                            <option ${item.store=='Thriftys'?'selected':''}>Thriftys</option>
                            <option ${item.store=='SaveOn'?'selected':''}>SaveOn</option>
                        </select>
                        <div style="display:flex; gap:10px;">
                            <input type="number" id="edit-price-${item.item_name}" value="${item.price}" placeholder="Price">
                        </div>
                        <input type="text" id="edit-note-${item.item_name}" value="${item.note}" placeholder="Note">
                        <div style="display:flex; gap:10px; margin-top:8px;">
                            <button class="btn-primary" onclick="saveEdit('${item.item_name}')">Save</button>
                            <button class="btn-action" onclick="cancelEdit('${item.item_name}')">Cancel</button>
                        </div>
                    </div>
                `;
            }
            listDiv.appendChild(div);
        });

        document.getElementById('clear-btn').style.display = hasCompleted ? 'block' : 'none';
    }

    // --- 6. ACTIONS ---
    async function addItem() {
        const input = document.getElementById('add-item');
        const name = toTitleCase(input.value.trim());
        if (!name) return;

        // Smart Category
        let cat = 'Other';
        for (const [key, val] of Object.entries(groceryMapping)) {
            if (name.toLowerCase().includes(key.toLowerCase())) cat = val;
        }

        const payload = {
            item_name: name,
            category: cat,
            store: document.getElementById('add-store').value,
            price: document.getElementById('add-price').value,
            note: document.getElementById('add-note').value
        };

        // Optimistic UI
        allItems.unshift({ ...payload, status: 0 });
        renderList();
        input.value = ''; document.getElementById('add-price').value=''; document.getElementById('add-note').value='';
        document.getElementById('ghostInput').value = '';

        await api('POST', payload);
        fetchItems(); // Sync real ID/Data
    }

    async function updateStatus(name, action) {
        // Optimistic UI
        const item = allItems.find(i => i.item_name === name);
        if (item) item.status = (action === 'gotit' ? 1 : 0);
        renderList();
        await api('PUT', { action, item_name: name });
    }

    async function deleteItem(name) {
        if (!confirm("Remove " + name + "?")) return;
        allItems = allItems.filter(i => i.item_name !== name);
        renderList();
        await api('DELETE', { item_name: name });
    }

    async function clearCompleted() {
        if (!confirm("Clear all completed?")) return;
        allItems = allItems.filter(i => i.status === 0);
        renderList();
        await api('DELETE', { action: 'clear_completed' });
    }

    // Edit Logic
    function enableEdit(name) {
        const item = allItems.find(i => i.item_name === name);
        if(item) item.isEditing = true;
        renderList();
    }
    function cancelEdit(name) {
        const item = allItems.find(i => i.item_name === name);
        if(item) item.isEditing = false;
        renderList();
    }
    async function saveEdit(name) {
        const item = allItems.find(i => i.item_name === name);
        if(!item) return;
        
        item.store = document.getElementById(`edit-store-${name}`).value;
        item.price = document.getElementById(`edit-price-${name}`).value;
        item.note = document.getElementById(`edit-note-${name}`).value;
        item.isEditing = false;
        
        renderList();
        
        await api('PUT', {
            action: 'edit',
            item_name: name,
            store: item.store,
            price: item.price,
            note: item.note,
            category: item.category // Persist existing category
        });
    }

    // --- 7. AUTOCOMPLETE HELPERS ---
    const inputEl = document.getElementById('add-item');
    const ghostEl = document.getElementById('ghostInput');

    inputEl.addEventListener('input', () => {
        const val = inputEl.value;
        const match = val ? groceryItems.find(i => i.toLowerCase().startsWith(val.toLowerCase())) : null;
        ghostEl.value = (match && match.toLowerCase() !== val.toLowerCase()) ? val + match.slice(val.length) : "";
    });

    inputEl.addEventListener('keydown', (e) => {
        if ((e.key === 'Tab' || e.key === 'ArrowRight' || e.key === 'Enter') && ghostEl.value) {
            e.preventDefault();
            inputEl.value = toTitleCase(ghostEl.value);
            ghostEl.value = "";
            if (e.key === 'Enter') addItem();
        } else if (e.key === 'Enter') {
            addItem();
        }
    });

    function toTitleCase(str) {
        return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
    }
</script>

</body>
</html>